<!DOCTYPE html>
<html>

<head>
  <title>BoardSpace: A Space for Boards</title>
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <script src="/javascripts/classes.js"></script>
</head>

<body>
  <input type="hidden" id="code" value="<%=boardcode%>" />
  <h1>ur board</h1>
  <p>
    code: <%= boardcode %>
  </p>
  <p>
    can edit: <%= canEdit %>
  </p>
  <div id="drawing-goes-here"><svg width="500" height="500" id="drawing-svg"></svg></div>
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
  const BOARD_WIDTH = 500;
  const BOARD_HEIGHT = 500;
  const POLL_RATE = 10;
  let nextId = 0;
  let poll = POLL_RATE;
  let mouseX = 0;
  let mouseY = 0;
  let mouseDown = false;
  let lastTimestamp;
  let board = {};
  let penSize = 3;
  let color = 'black';


  const socket = io();
  const code = document.getElementById("code").value;

  socket.emit('join', { code: code });
  socket.on('joindata', function (data) {
    nextId = data.nextId;
    board = data.board;
    let newBoard = {};
    for (key in board) {
      if (board[key].type == "Pen") {
        newBoard[key] = new Pen(key, board[key].shapeData, { x: 0, y: 0 }, { x: 0, y: 0 }, board[key].size, board[key].color);
      }
    }
    board = newBoard;
    compileBoard();
  });
  socket.emit('change', { code: code });
  socket.on('change', function (data) {
    console.log(data);
  });
  socket.on('add', function(data) {
    if (nextId != data.id) {
      if (data.type == "Pen") {
        board[data.id] = new Pen(data.id, data.shapeData, { x: 0, y: 0 }, { x: 0, y: 0 }, data.size, data.color);
      }
    }
    compileBoard();
  });

  socket.on('newId', function(data) {
    nextId = data.newId;
  });

  // get svg
  let svg = document.getElementById("drawing-svg");

  svg.onmousemove = (event) => {
    let box = svg.getBoundingClientRect();
    mouseX = event.clientX - box.left;
    mouseY = event.clientY - box.top;
  };

  svg.onmousedown = (event) => {
    mouseDown = true;
    // if pen is selected tool
    board[nextId] = new Pen(nextId, [], { x: 0, y: 0 }, { x: 0, y: 0 }, penSize, color);
    socket.emit('add', {code: code, id: nextId, shapeData: board[nextId].shapeData, size: board[nextId].size, color: board[nextId].color, type: "Pen"});
  }

  svg.onmouseup = (event) => {
    console.log(nextId);
    socket.emit("requestNewId", {code:code});
    mouseDown = false;
  }

  function compileBoard() {
    // clear board
    while (svg.lastChild) {
      svg.removeChild(svg.lastChild);
    }
    // add elements
    for (let id in board) {
      let element = board[id].getSvg();
      svg.appendChild(element);
    }
    canvas = document.getElementById("drawing-svg");
  }

  function plotPenPoint() {
    board[nextId].shapeData.push({ x: mouseX, y: mouseY });
    socket.emit('add', {code: code, id: nextId, shapeData: board[nextId].shapeData, size: board[nextId].size, color: board[nextId].color, type: "Pen"});
    compileBoard();
  }

  // we're not actually animating lol
  function animate(timestamp) {
    deltaTime = lastTimestamp ? timestamp - lastTimestamp : 0;
    lastTimestamp = timestamp;
    poll -= deltaTime;
    if (poll < 0 && mouseDown) {
      // if tool == pen /freeform drawing
      plotPenPoint();
      poll = POLL_RATE;
    }

    window.requestAnimationFrame(animate);
  }
  animate();

  compileBoard();
</script>

</html>